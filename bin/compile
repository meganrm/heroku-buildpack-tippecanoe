#!/usr/bin/env bash

set -eo pipefail

# debug
# set -x

BUILD_DIR=$1

DEP_URL=https://github.com/mapbox/tippecanoe.git
VERSION="1.34.3"

WORK_DIR=$BUILD_DIR/.tippecanoe
mkdir -p $WORK_DIR

function topic() {
  echo "-----> $*"
}

function step() {
  echo "=== $*"
}

topic "Installing tippecanoe"
step "Downloading from github"

git clone --depth 1 --branch $VERSION $DEP_URL $WORK_DIR -q

step "Compiling binaries"

cd $WORK_DIR
make -j

step "Installing binaries to vendor"

# Default `make install` assumes writable /usr/local, which is not true
# during slug compilation. Instead, write everything to /app/bin and blackhole
# man output.

make install PREFIX=$BUILD_DIR MANDIR=$WORK_DIR
rm -r $WORK_DIR

step "Tippecanoe installation done."
