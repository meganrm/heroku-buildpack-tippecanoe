#!/usr/bin/env bash

set -eo pipefail

# debug
# set -x

BUILD_DIR=$1

WORK_DIR=$BUILD_DIR/.tippecanoe
mkdir -p $WORK_DIR

INSTALL_DIR=$BUILD_DIR/vendor
mkdir -p $INSTALL_DIR

function topic() {
  echo "-----> $*"
}

function step() {
  echo "=== $*"
}

topic "Installing tippecanoe"
step "Downloading from github"

DEP_URL=https://github.com/mapbox/tippecanoe.git
VERSION="1.34.3"

git clone --depth 1 --branch $VERSION $DEP_URL $WORK_DIR -q

step "Compiling binary"

cd $WORK_DIR
make -j tippecanoe

step "Installing binary to vendor"

# we can't `make install` because it assumes writable `/usr/local`
# also we don't need the other binaries this compiles

cp $WORK_DIR/tippecanoe $INSTALL_DIR
rm -r $WORK_DIR

step "Tippecanoe installation done."
