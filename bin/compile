#!/usr/bin/env bash

set -eo pipefail

# debug
# set -x

BUILD_DIR=$1

WORK_DIR=$BUILD_DIR/.tippecanoe
mkdir -p $WORK_DIR

INSTALL_DIR=$BUILD_DIR/vendor
mkdir -p $INSTALL_DIR

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function topic() {
  echo "-----> $*"
}

topic "Fetching build dependencies"

apt-get install libsqlite3-dev

topic "Downloading tippecanoe"

DEP_URL=https://github.com/mapbox/tippecanoe.git
VERSION="1.34.3"

git clone --depth 1 --branch $VERSION $DEP_URL $WORK_DIR -q

topic "Compiling tippecanoe binary"

cd $WORK_DIR
make -j tippecanoe | indent

topic "Installing tippecanoe binary"

# we can't `make install` because it assumes writable `/usr/local`
# also we don't need the other binaries this compiles

cp $WORK_DIR/tippecanoe $INSTALL_DIR
rm -r $WORK_DIR
